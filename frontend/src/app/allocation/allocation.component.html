<div class="allocation-container">
  <div class="header">
    <h1>ğŸ¯ Fragment Allocation</h1>
    <p class="subtitle">Optimize and distribute RDF fragments across cluster nodes</p>
  </div>

  <!-- Configuration Form -->
  <div class="config-section card">
    <h2>âš™ï¸ Configuration</h2>
    <div class="form-grid">
      <div class="form-group">
        <label for="datasetName">Dataset Name</label>
        <input 
          type="text" 
          id="datasetName" 
          [(ngModel)]="datasetName" 
          [disabled]="isAllocating || isDistributing"
          placeholder="e.g., watdiv100k">
      </div>
      
      <div class="form-group">
        <label for="numMachines">Number of Machines</label>
        <input 
          type="number" 
          id="numMachines" 
          [(ngModel)]="numMachines" 
          [disabled]="isAllocating || isDistributing"
          min="1" 
          max="50"
          placeholder="10">
      </div>
    </div>
    
    <div class="form-group checkbox-group">
      <label class="checkbox-label">
        <input 
          type="checkbox" 
          [(ngModel)]="cleanAfter"
          [disabled]="isAllocating || isDistributing">
        <span>ğŸ—‘ï¸ Clean local files after distribution (saves disk space)</span>
      </label>
      <p class="help-text">After successful distribution, local fragments and allocation results will be removed. All data remains on the cluster.</p>
    </div>

    <div class="action-buttons">
      <button 
        class="btn btn-primary"
        (click)="startAllocation()"
        [disabled]="isAllocating || isDistributing || !datasetName || allocationCompleted">
        <span *ngIf="!isAllocating">ğŸš€ Start Allocation</span>
        <span *ngIf="isAllocating">
          <span class="spinner"></span> Allocating...
        </span>
      </button>

      <button 
        class="btn btn-success"
        (click)="distributeToCluster()"
        [disabled]="!allocationCompleted || isDistributing || distributionCompleted">
        <span *ngIf="!isDistributing">ğŸ“¤ Distribute to Cluster</span>
        <span *ngIf="isDistributing">
          <span class="spinner"></span> Distributing...
        </span>
      </button>
    </div>
  </div>

  <!-- Error Message -->
  <div class="alert alert-error" *ngIf="errorMessage">
    <strong>âŒ Error:</strong> {{ errorMessage }}
  </div>

  <!-- Progress Steps -->
  <div class="progress-section card" *ngIf="isAllocating || allocationCompleted">
    <h2>ğŸ“Š Pipeline Progress</h2>
    <div class="steps">
      <div 
        *ngFor="let step of steps; let i = index" 
        class="step"
        [class.active]="(i < 3 && currentStep === i) || (i === 3 && isDistributing)"
        [class.completed]="step.completed">
        <div class="step-icon">
          <span *ngIf="!step.completed && ((i < 3 && currentStep !== i) || (i === 3 && !isDistributing))">{{ i + 1 }}</span>
          <span *ngIf="!step.completed && ((i < 3 && currentStep === i) || (i === 3 && isDistributing))" class="spinner-small"></span>
          <span *ngIf="step.completed">âœ“</span>
        </div>
        <div class="step-content">
          <div class="step-name">{{ step.name }}</div>
          <div class="step-description">{{ step.description }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Section -->
  <div class="results-section" *ngIf="allocationResponse">
    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">ğŸ“¦</div>
        <div class="stat-content">
          <div class="stat-value">{{ formatNumber(allocationResponse.statistics.totalFragments) }}</div>
          <div class="stat-label">Total Fragments</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">ğŸ”—</div>
        <div class="stat-content">
          <div class="stat-value">{{ formatNumber(allocationResponse.statistics.totalEdges) }}</div>
          <div class="stat-label">Graph Edges</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">â±ï¸</div>
        <div class="stat-content">
          <div class="stat-value">{{ allocationResponse.statistics.executionTime?.toFixed(2) }}s</div>
          <div class="stat-label">Execution Time</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">ğŸ–¥ï¸</div>
        <div class="stat-content">
          <div class="stat-value">{{ numMachines }}</div>
          <div class="stat-label">Target Machines</div>
        </div>
      </div>
    </div>

    <!-- Distribution Chart -->
    <div class="chart-section card">
      <h2>ğŸ“ˆ Fragment Distribution</h2>
      <div class="chart-container">
        <div class="chart-bars">
          <div 
            *ngFor="let item of getChartData()" 
            class="bar-group">
            <div class="bar-wrapper">
              <div 
                class="bar"
                [style.height.%]="(item.value / getMaxFragmentCount()) * 100"
                [style.background-color]="item.color">
                <span class="bar-value">{{ item.value }}</span>
              </div>
            </div>
            <div class="bar-label">{{ item.label }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Distribution Table -->
    <div class="table-section card">
      <h2>ğŸ“‹ Detailed Distribution</h2>
      <table class="distribution-table">
        <thead>
          <tr>
            <th>Machine ID</th>
            <th>Worker IP</th>
            <th>Fragments</th>
            <th>Percentage</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let machine of allocationResponse.distribution">
            <td><strong>Worker {{ machine.machineId }}</strong></td>
            <td><code>{{ machine.workerIp }}</code></td>
            <td>{{ formatNumber(machine.fragmentCount) }}</td>
            <td>
              <div class="percentage-bar">
                <div 
                  class="percentage-fill"
                  [style.width.%]="(machine.fragmentCount / allocationResponse.statistics.totalFragments) * 100">
                </div>
                <span class="percentage-text">
                  {{ ((machine.fragmentCount / allocationResponse.statistics.totalFragments) * 100).toFixed(1) }}%
                </span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Files Section -->
    <div class="files-section card">
      <h2>ğŸ“ Generated Files</h2>
      <div class="file-list">
        <div class="file-item">
          <span class="file-icon">ğŸ“Š</span>
          <code>{{ allocationResponse.statistics.dbStatFile }}</code>
        </div>
        <div class="file-item">
          <span class="file-icon">ğŸ•¸ï¸</span>
          <code>{{ allocationResponse.statistics.graphFile }}</code>
        </div>
        <div class="file-item">
          <span class="file-icon">ğŸ“</span>
          <code>{{ allocationResponse.affectationFile }}</code>
        </div>
      </div>
    </div>

    <!-- Success Message -->
    <div class="alert alert-success" *ngIf="distributionCompleted">
      <strong>âœ… Success!</strong> Fragments have been successfully distributed to all {{ numMachines }} cluster nodes.
    </div>
  </div>
</div>
